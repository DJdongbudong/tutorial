# Hadoop分布式文件系统：HDFS

## 概述

### 设计理念

HDFS的设计理念是可以运行在普通机器上，以流式数据方式存取文件，一次写入，多次查询。

1. 可构建在廉价机器上：HDFS设计理念之一就是让它能运行在普通的硬件之上，即便硬件出现故障，也可以通过容错策略来保证数据的高可用。
2. 高容错性：HDFS将数据自动保存多个副本，副本丢失后，自动恢复，实现数据高容错性。
3. 适合批处理：也称为流式数据访问。HDFS适合一次写入、多次查询（读取）的情况。在数据集生成后，长时间在此数据集上进行各种分析。
4. 适合存储大文件：单个文件大，文件数量规模大。

### 局限

1. 实时性不好：要求低时间延迟的访问的应用，不适合在HDFS上运行。记住，HDFS是为高数据吞吐量应用优化的，这可能会以高时间延迟为代价。目前，对于低延迟的访问需求，HBase是更好的选择。
2. 小文件问题：由于NameNode将文件系统的元数据存储在内存中，因此该文件系统所能存储的文件总量受限于NameNode的内存总容量。根据经验，每个文件、目录和数据块的存储信息大约占150字节。过多的小文件存储会大量消耗NameNode的存储量。
3. 文件修改问题：HDFS中的文件只有一个Writer，它不支持具有多个写入者的操作，也不支持在文件的任意位置进行修改。

### 架构

HDFS是一个主从结构，一个HDFS集群由一个（用于管理文件命名空间和调节客户端访问文件的主服务器）节点NameNode和一些（用于存储具体文件数据的服务器）节点DataNodes组成。

- NameNode：负责管理文件目录、文件和Block的对应关系以及Block和DataNode的对应关系。NameNode节点也成为元数据节点，用来管理文件系统的命名空间，维护目录树，接管用户的请求。 
  - 将文件的元数据保存在一个文件目录树中。
  - 在磁盘上保存为：fsimage和edits。
  - 保存DataNode的数据信息的文件，在系统启动时读入内存。
- DataNode：Datanode是文件系统的工作节点。它们根据需要存储并检索数据块（受客户端或NameNode调度），并且定期向NameNode发送他们所存储的块的列表。
- Client：客户端代表用户通过与NameNode和DataNode交互来访问整个文件系统。客户端提供了一个类似于POSIX（可移植操作系统界面）的文件系统接口，因此用户在编程时无需知道NameNode和DataNode也可以实现其功能。HDFS对外开放文件命名空间并允许用户数据以文件形式存储。用户通过客户端（Client）与HDFS进行通讯交互。
- SecondaryNameNode：文件系统客户端在执行写操作时，这些操作首先被记录到编辑日志中，然后更新NameNode内存中维护的文件系统的元数据；命名空间镜像文件（fsimage）是文件系统元数据的一个永久检查点，因为fsimage文件是一个大型文件，如果频繁的执行写操作，会使系统运行极为缓慢。但是如果不进行操作，editlog文件会无限增长，一旦NameNode需要恢复，则需要花费非常长的时间，所以HDFS引入了辅助NameNode，为主NameNode内存中的文件系统元数据创建检查点。实现将主NameNode的编辑日志和命名空间镜像文件合并。形成一个更小的editlog文件和最新的fsimage文件。客户端执行写操作的时候，首先更新编辑日志（edits），然后修改内存中的文件系统映射。随着时间的推移，编辑日志会非常大。这个时候，就需要将编辑日志和文件系统映射持久检查点（fsimage）进行合并，以减少编辑日志的大小。这个工作就是由辅助NameNode完成的。SecondaryNameNode工作原理：
  1. 辅助NameNode请求主NameNode停止使用edits文件，暂时将新的写操作记录到一个新的文件中；
  2. 辅助NameNode通过http get请求从主NameNode获取fsimage和edits文件；
  3. 辅助NameNode将fsimage文件载入内存，逐一执行edits文件中的操作，创建新的fsimage文件；
  4. 辅助NameNode通过使用http post将新的fsimage文件发送回主NameNode；
  5. 主NameNode用从辅助NameNode接收的fsimage文件替换旧的fsimage文件；用步骤1所产生的edits文件替换旧的edits文件。同时，还更新fstime文件来记录检查点执行时间。

最终，主NameNode拥有最新的fsimage文件和一个更小的edits文件。当NameNode处在安全模式时，管理员也可调用hadoop dfsadmin –saveNameSpace命令来创建检查点。

从上面的过程中我们清晰的看到辅助NameNode和主NameNode拥有相近内存需求的原因（因为辅助NameNode也把fsimage文件载入内存）。因此，在大型集群中，辅助NameNode需要运行在一台专用机器上。

创建检查点的触发条件受两个配置参数控制。通常情况下，辅助NameNode每隔一小时（有fs.checkpoint.period属性设置）创建检查点；此外，当编辑日志的大小达到64MB（有fs.checkpoint.size属性设置）时，也会创建检查点。系统每隔五分钟检查一次编辑日志的大小。

### 块

HDFS内部机制是将一个文件分割成一个或多个块，这些块被存储在一组数据节点中。NameNode节点用来操作文件命名空间的文件或目录操作，如打开，关闭，重命名等等。它同时确定块与数据节点DataNode的映射。数据节点DataNode负责来自文件系统客户的读写请求。数据节点DataNode同时还要执行块的创建，删除，和来自NameNode的块复制指令。

dfs.blocksize是一个文件块的大小，默认64M。 
每一个block会在多个DataNode上存储多份副本，默认是3份。 
太大的话会有较少map同时计算，太小的话也浪费可用map个数资源，而且文件太小NameNode就浪费内存多。所以应该根据需要进行设置。
